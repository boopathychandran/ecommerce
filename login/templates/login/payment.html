{% extends "base.html" %}
{% load static %}

{% block title %}Secure Transaction | Chandran Electronics{% endblock %}

{% block extra_css %}
<style>
    .order-summary-card {
        background: white;
        border-radius: 20px;
        padding: 2.5rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .payment-stepper {
        display: flex;
        justify-content: space-between;
        margin-bottom: 3rem;
        position: relative;
    }

    .payment-stepper::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background: #e2e8f0;
        z-index: 1;
    }

    .step {
        position: relative;
        z-index: 2;
        background: var(--bg-main);
        padding: 0 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        border: 2px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: var(--text-muted);
    }

    .step-circle.completed {
        background: #10b981;
        border-color: #10b981;
        color: white;
    }

    .step.active .step-circle {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
        box-shadow: var(--shadow-neon);
    }

    .step.active .step-label {
        color: var(--primary);
        font-weight: 700;
    }

    .step-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-muted);
    }

    .info-box {
        background: #f8fafc;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #e2e8f0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="padding: 4rem 2rem;">
    <div class="animate-in" style="max-width: 900px; margin: 0 auto;">

        <!-- Stepper -->
        <div class="payment-stepper">
            <div class="step">
                <div class="step-circle completed"><span class="material-icons" style="font-size: 20px;">check</span>
                </div>
                <div class="step-label">Shipping</div>
            </div>
            <div class="step active">
                <div class="step-circle">2</div>
                <div class="step-label">Payment</div>
            </div>
            <div class="step">
                <div class="step-circle">3</div>
                <div class="step-label">Review</div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 350px; gap: 3rem;">
            <!-- Left Side: Summary & Details -->
            <div style="display: flex; flex-direction: column; gap: 2rem;">
                <div class="order-summary-card">
                    <h2 style="font-family: var(--font-heading); margin-bottom: 1.5rem;">Order Review</h2>

                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        {% for item in cart %}
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <div
                                    style="width: 50px; height: 50px; border-radius: 8px; background: #f1f5f9; overflow: hidden; border: 1px solid #e2e8f0;">
                                    {% if item.product.image %}
                                    <img src="{{ item.product.image.url }}" alt=""
                                        style="width: 100%; height: 100%; object-fit: cover;">
                                    {% else %}
                                    <div style="display:flex; align-items:center; justify-content:center; height:100%;">
                                        <span class="material-icons" style="color:#cbd5e1;">image</span>
                                    </div>
                                    {% endif %}
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-main);">{{ item.product.name }}
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">Qty: {{ item.quantity }}
                                    </div>
                                </div>
                            </div>
                            <div style="font-weight: 700; color: var(--text-main);">₹{{ item.total_price }}</div>
                        </div>
                        {% endfor %}
                    </div>

                    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 1.25rem; font-weight: 700;">Final Amount</span>
                            <span style="font-size: 1.75rem; font-weight: 800; color: var(--primary);">₹{{
                                total|floatformat:2 }}</span>
                        </div>
                    </div>
                </div>

                <div class="order-summary-card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="font-family: var(--font-heading); margin: 0;">Shipping To</h3>
                        <a href="{% url 'address' %}"
                            style="font-size: 0.85rem; color: var(--primary); font-weight: 600; text-decoration: none;">Change</a>
                    </div>
                    <div class="info-box">
                        <div style="font-weight: 700; margin-bottom: 0.5rem; color: var(--text-main);">{{ address.name
                            }}</div>
                        <div style="line-height: 1.6; color: var(--text-muted);">
                            {{ address.address }}<br>
                            {{ address.city }}, {{ address.pincode }}<br>
                            <span style="display: flex; align-items: center; gap: 5px; margin-top: 5px;">
                                <span class="material-icons" style="font-size: 16px;">phone</span> {{ address.phone }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Side: Pay Action -->
            <div style="position: sticky; top: 120px; align-self: start;">
                <div class="order-summary-card"
                    style="text-align: center; display: flex; flex-direction: column; gap: 1.5rem;">
                    <div
                        style="width: 70px; height: 70px; border-radius: 50%; background: #f0f9ff; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                        <span class="material-icons" style="color: #0ea5e9; font-size: 35px;">verified_user</span>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 0.5rem;">Secure Checkout</h3>
                        <p style="font-size: 0.85rem; color: var(--text-muted);">Clicking authorize will open the secure
                            Razorpay payment gateway.</p>
                    </div>

                    <button id="rzp-button" class="btn-primary"
                        style="height: 60px; font-size: 1.1rem; border-radius: 15px; width: 100%;">
                        Authorize Payment
                    </button>

                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <img src="https://razorpay.com/assets/razorpay-glyph.svg" style="width: 20px;" alt="">
                        <span style="font-size: 0.75rem; font-weight: 600; color: #64748b;">Secured by Razorpay</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    var rzpBtn = document.getElementById('rzp-button');
    if (rzpBtn) {
        rzpBtn.addEventListener('click', function (e) {
            e.preventDefault();
            this.textContent = 'Opening Gateway...';
            this.disabled = true;

            var options = {
                "key": "{{ razorpay_key }}",
                "amount": "{{ amount }}",
                "currency": "INR",
                "name": "Chandran Electronics",
                "description": "Tech Order Payment",
                "order_id": "{{ order_id }}",
                "handler": function (response) {
                    fetch("{% url 'payment_success' %}", {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(response)
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Payment Successful!',
                                    text: 'Your order has been confirmed.',
                                    showConfirmButton: false,
                                    timer: 2000
                                }).then(() => {
                                    window.location.href = "{% url 'ecommerce' %}";
                                });
                            } else {
                                alert("Error: " + data.error);
                                window.location.reload();
                            }
                        })
                        .catch(err => alert("Network Error: " + err));
                },
                "modal": {
                    "ondismiss": function () {
                        rzpBtn.textContent = 'Authorize Payment';
                        rzpBtn.disabled = false;
                    }
                },
                "theme": { "color": "#4f46e5" }
            };
            var rzp = new Razorpay(options);
            rzp.open();
        });
    }
</script>
{% endblock %}